
LINK_LIBS = $(CRTLIB) $(USERLIBS)

MAP = $(OUTDIR)\$(NAME).$(EXT).map
PDB = $(OUTDIR)\$(NAME).$(EXT).pdb
RES = $(INTDIR)\$(NAME).res

!ifndef RC_NAME
RC_NAME=$(NAME)
!endif

.cpp{$(INTDIR)}.obj::
	$(CPP) @<<
	$(CPPFLAGS) $<
<<

{../common/}.cpp{$(INTDIR)}.obj::
	$(CPP) @<<
	$(CPPFLAGS) $<
<<

{../ConEmuPlugin/}.cpp{$(INTDIR)}.obj::
	$(CPP) @<<
	$(CPPFLAGS) $<
<<

{../ConEmuHk/}.cpp{$(INTDIR)}.obj::
	$(CPP) @<<
	$(CPPFLAGS) $<
<<

{../ConEmuCD/}.cpp{$(INTDIR)}.obj::
	$(CPP) @<<
	$(CPPFLAGS) $<
<<

.c{$(INTDIR)}.obj::
	$(CPP) @<<
	$(CPPFLAGS) $<
<<

{../modules/minhook/src/}.c{$(INTDIR)}.obj::
	$(CPP) @<<
	$(CPPFLAGS) $<
<<

{../ConEmuC/}.cpp{$(INTDIR)}.obj::
	$(CPP) @<<
	$(CPPFLAGS) $<
<<

# echo ml /nologo /c /Fo$@ $<
{$(COMMONSRCDIR)/}.asm{$(INTDIR)}.obj::
    ml /c /Fo"$(OBJDIR)/" $<


#ALL: dirs build release


printcpp:
	@echo $(CLR_BRN)compiling `$(NAME)`$(CLR_STD)
	@echo/  $(CPPFLAGS)


dirs:
	@echo $(CLR_MOD)creating temp directories$(CLR_STD)
	@echo :: $(OUTDIR)
	@if not exist "$(WORKDIR)\$(NULL)" mkdir "$(WORKDIR)"
	@if not exist "$(INTDIR)\$(NULL)" mkdir "$(INTDIR)"
	@if not exist "$(OUTDIR)\$(NULL)" mkdir "$(OUTDIR)"


release:
!if defined(FIXOSVER)
	@echo $(CLR_BRN)downgrading required OS version to $(FIXOSVER)$(CLR_STD)
	@editbin /SUBSYSTEM:$(SUBSYSTEM),$(FIXOSVER) /osversion:$(FIXOSVER) $(OUTFULLNAME) > "$(WORKDIR)\editbin.log"
!endif
	@echo $(CLR_MOD)copying release files$(CLR_STD)
	@if not exist "$(RELEASEDIR)\$(NULL)" mkdir "$(RELEASEDIR)"
	@echo moving `$(OUTFULLNAME)` to `$(RELEASEDIR)`
	@move "$(OUTFULLNAME)" "$(RELEASEDIR)\$(NULL)" > nul
	@echo moving `$(MAP)` to `$(RELEASEDIR)`
	@move "$(MAP)" "$(RELEASEDIR)\$(NULL)" > nul
!if "$(USE_PDB)" == "1" && !defined(NO_RELEASE_PDB)
	@echo copying `$(PDB)` to `$(RELEASEDIR)`
	@copy "$(PDB)" "$(RELEASEDIR)\$(NULL)" > nul
!endif

clean:
	@echo $(CLR_BRN)erasing temp directories$(CLR_STD)
	@if exist "$(OBJDIR)\$(NULL)" rmdir /Q /S "$(OBJDIR)"

$(INTDIR)\crt_fix.obj: ../common/crt_fix.asm

$(INTDIR)\crt_fix_wrap.obj: ../common/crt_fix_wrap.cpp
